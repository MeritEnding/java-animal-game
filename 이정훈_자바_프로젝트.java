package Ïù¥Ï†ïÌõà_ÏûêÎ∞î_ÌîÑÎ°úÏ†ùÌä∏;

import javax.sound.sampled.*;
import javax.swing.*;
import javax.swing.border.EmptyBorder;
import java.awt.*;
import java.awt.event.ActionListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.io.IOException;
import java.net.URL;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

public class Ïù¥Ï†ïÌõà_ÏûêÎ∞î_ÌîÑÎ°úÏ†ùÌä∏ extends JFrame {

    private CardLayout cardLayout;
    private JPanel mainPanel;
    private GameTheme currentTheme;
    private Difficulty currentDifficulty;

    public Ïù¥Ï†ïÌõà_ÏûêÎ∞î_ÌîÑÎ°úÏ†ùÌä∏() {
        setTitle("Ïù¥Ï†ïÌõàÏùò Ïπ¥Îìú ÎßûÏ∂îÍ∏∞ Í≤åÏûÑ");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setSize(800, 850);
        setLocationRelativeTo(null);

        cardLayout = new CardLayout();
        mainPanel = new JPanel(cardLayout);

        // 1. ÏãúÏûë ÌôîÎ©¥
        mainPanel.add(new StartScreen(this::showDifficultyScreen), "Start");
        // 2. ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù ÌôîÎ©¥ (ÌÖåÎßà ÏÑ†ÌÉù ÌõÑ ÎèôÏ†Å ÏÉùÏÑ±)
        // 3. Í≤åÏûÑ ÌôîÎ©¥ (ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù ÌõÑ ÎèôÏ†Å ÏÉùÏÑ±)
        // 4. Í≤åÏûÑ Ï¢ÖÎ£å ÌôîÎ©¥ (Í≤åÏûÑ Ï¢ÖÎ£å ÌõÑ ÎèôÏ†Å ÏÉùÏÑ±)

        add(mainPanel);
        setVisible(true);
    }

    public void showDifficultyScreen(GameTheme theme) {
        this.currentTheme = theme;
        DifficultyScreen difficultyScreen = new DifficultyScreen(
                e -> startGame(Difficulty.EASY),
                e -> startGame(Difficulty.NORMAL),
                e -> startGame(Difficulty.HARD)
        );
        mainPanel.add(difficultyScreen, "Difficulty");
        cardLayout.show(mainPanel, "Difficulty");
    }

    public void startGame(Difficulty difficulty) {
        this.currentDifficulty = difficulty;
        GameScreen gameScreen = new GameScreen(currentTheme, currentDifficulty, this::showEndScreen, this::showStartScreen);
        mainPanel.add(gameScreen, "Game");
        cardLayout.show(mainPanel, "Game");
    }

    public void showEndScreen(String message, boolean isWin) {
        EndScreen endScreen = new EndScreen(message, isWin,
                e -> showDifficultyScreen(currentTheme),
                e -> showStartScreen()
        );
        mainPanel.add(endScreen, "End");
        cardLayout.show(mainPanel, "End");
    }

    public void showStartScreen() {
        cardLayout.show(mainPanel, "Start");
    }

    public static void main(String[] args) {
        // UIÎ•º Îçî ÏòàÏÅòÍ≤å ÎßåÎì§Í∏∞ ÏúÑÌï¥ Nimbus LookAndFeel Ï†ÅÏö©
        try {
            for (UIManager.LookAndFeelInfo info : UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (Exception e) {
            // NimbusÎ•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ LookAndFeel ÏÇ¨Ïö©
        }
        SwingUtilities.invokeLater(Ïù¥Ï†ïÌõà_ÏûêÎ∞î_ÌîÑÎ°úÏ†ùÌä∏::new);
    }
}

// =================================================================================
// ÌôîÎ©¥ Íµ¨ÏÑ± ÏöîÏÜå (Panels)
// =================================================================================


class StartScreen extends JPanel {
    public StartScreen(ThemeSelectListener listener) {
        setLayout(new BorderLayout(20, 30));
        setBorder(new EmptyBorder(80, 80, 80, 80));
        setBackground(UIFactory.COLOR_BACKGROUND);

        JLabel titleLabel = UIFactory.createLabel("Ïπ¥Îìú ÎßûÏ∂îÍ∏∞ Í≤åÏûÑ", UIFactory.FONT_TITLE_MAIN);
        titleLabel.setHorizontalAlignment(SwingConstants.CENTER);
        add(titleLabel, BorderLayout.NORTH);

        JPanel buttonPanel = new JPanel(new GridLayout(1, 2, 40, 0));
        buttonPanel.setOpaque(false);

        GameTheme animalTheme = new GameTheme("Animal");
        GameTheme fruitTheme = new GameTheme("Fruit");

        JButton animalButton = UIFactory.createButton("ÎèôÎ¨º ÏπúÍµ¨Îì§ üêµ", animalTheme.cardBack, e -> listener.onThemeSelected(animalTheme));
        JButton fruitButton = UIFactory.createButton("ÏÉàÏΩ§Îã¨ÏΩ§ Í≥ºÏùº üçì", fruitTheme.cardBack, e -> listener.onThemeSelected(fruitTheme));

        buttonPanel.add(animalButton);
        buttonPanel.add(fruitButton);

        add(buttonPanel, BorderLayout.CENTER);
    }

    @FunctionalInterface
    interface ThemeSelectListener {
        void onThemeSelected(GameTheme theme);
    }
}


class DifficultyScreen extends JPanel {
    public DifficultyScreen(ActionListener onEasy, ActionListener onNormal, ActionListener onHard) {
        setLayout(new BorderLayout(20, 30));
        setBorder(new EmptyBorder(80, 80, 80, 80));
        setBackground(UIFactory.COLOR_BACKGROUND);

        JLabel titleLabel = UIFactory.createLabel("ÎÇúÏù¥ÎèÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî", UIFactory.FONT_TITLE);
        titleLabel.setHorizontalAlignment(SwingConstants.CENTER);
        add(titleLabel, BorderLayout.NORTH);

        JPanel buttonPanel = new JPanel(new GridLayout(3, 1, 0, 20));
        buttonPanel.setOpaque(false);

        JButton easyButton = UIFactory.createButton("Easy", UIFactory.COLOR_EASY, onEasy);
        JButton normalButton = UIFactory.createButton("Normal", UIFactory.COLOR_NORMAL, onNormal);
        JButton hardButton = UIFactory.createButton("Hard", UIFactory.COLOR_HARD, onHard);

        buttonPanel.add(easyButton);
        buttonPanel.add(normalButton);
        buttonPanel.add(hardButton);

        add(buttonPanel, BorderLayout.CENTER);
    }
}

class EndScreen extends JPanel {
    public EndScreen(String message, boolean isWin, ActionListener onRetry, ActionListener onMenu) {
        setLayout(new BorderLayout(20, 30));
        setBorder(new EmptyBorder(80, 80, 80, 80));
        setBackground(isWin ? new Color(220, 255, 220) : new Color(255, 220, 220));

        JLabel titleLabel = UIFactory.createLabel(message, UIFactory.FONT_TITLE);
        titleLabel.setForeground(isWin ? new Color(0, 100, 0) : new Color(139, 0, 0));
        titleLabel.setHorizontalAlignment(SwingConstants.CENTER);
        add(titleLabel, BorderLayout.CENTER);

        JPanel buttonPanel = new JPanel(new GridLayout(1, 2, 40, 0));
        buttonPanel.setOpaque(false);
        buttonPanel.setBorder(new EmptyBorder(20, 0, 0, 0));


        JButton retryButton = UIFactory.createButton("Îã§ÏãúÌïòÍ∏∞", UIFactory.COLOR_NORMAL, onRetry);
        JButton menuButton = UIFactory.createButton("Î©îÏù∏ Î©îÎâ¥", UIFactory.COLOR_HARD, onMenu);

        buttonPanel.add(retryButton);
        buttonPanel.add(menuButton);
        add(buttonPanel, BorderLayout.SOUTH);
    }
}


// =================================================================================
// Í≤åÏûÑ Î°úÏßÅ ÌïµÏã¨ (GameScreen)
// =================================================================================

class GameScreen extends JPanel {
    private final GameTheme theme;
    private final Difficulty difficulty;
    private final EndGameListener endGameListener;
    private final Runnable showStartScreenListener;

    private final JButton[][] buttons;
    private int[][] cardValues;
    private boolean[][] matched;

    private int firstSelectX = -1, firstSelectY = -1;
    private boolean isChecking = false;

    private Timer gameTimer;
    private int remainingSeconds;
    private int failCount;

    private JLabel timeLabel;
    private JLabel failLabel;

    public GameScreen(GameTheme theme, Difficulty difficulty, EndGameListener endGameListener, Runnable showStartScreenListener) {
        this.theme = theme;
        this.difficulty = difficulty;
        this.endGameListener = endGameListener;
        this.showStartScreenListener = showStartScreenListener;

        this.buttons = new JButton[difficulty.rows][difficulty.cols];
        this.cardValues = new int[difficulty.rows][difficulty.cols];
        this.matched = new boolean[difficulty.rows][difficulty.cols];
        this.remainingSeconds = difficulty.timeLimit;
        this.failCount = difficulty.failLimit;

        setLayout(new BorderLayout(10, 10));
        setBorder(new EmptyBorder(20, 20, 20, 20));
        setBackground(theme.background);

        initializeGameData();
        setupUI();
        startTimer();

        // Î™®Îì† ÎÇúÏù¥ÎèÑÏóêÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞ Í∏∞Îä• ÌôúÏÑ±Ìôî
        peekCards();
    }

    private void initializeGameData() {
        int numPairs = difficulty.rows * difficulty.cols / 2;
        String[] source = theme.themeName.equals("Animal") ? Data.ANIMALS : Data.FRUITS;

        List<Integer> cards = new ArrayList<>();
        for (int i = 0; i < numPairs; i++) {
            cards.add(i);
            cards.add(i);
        }
        Collections.shuffle(cards);

        int k = 0;
        for (int i = 0; i < difficulty.rows; i++) {
            for (int j = 0; j < difficulty.cols; j++) {
                cardValues[i][j] = cards.get(k++);
            }
        }
    }

    private void setupUI() {
        // ÏÉÅÎã® Ï†ïÎ≥¥ Ìå®ÎÑê
        JPanel infoPanel = new JPanel(new BorderLayout(20, 0));
        infoPanel.setOpaque(false);
        infoPanel.setBorder(new EmptyBorder(0, 10, 10, 10));

        // Ìôà Î≤ÑÌäº
        JButton homeButton = UIFactory.createButton("üè†", theme.cardBack, e -> {
            if(gameTimer != null) gameTimer.stop();
            showStartScreenListener.run();
        });
        infoPanel.add(homeButton, BorderLayout.WEST);

        // Ï§ëÏïô Ï†ïÎ≥¥ (ÏãúÍ∞Ñ, Ïã§Ìå®)
        JPanel statusPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 40, 0));
        statusPanel.setOpaque(false);

        timeLabel = UIFactory.createLabel("‚è≥ " + formatTime(remainingSeconds), UIFactory.FONT_INFO);
        statusPanel.add(timeLabel);

        failLabel = UIFactory.createLabel("üí£ " + failCount, UIFactory.FONT_INFO);
        statusPanel.add(failLabel);

        infoPanel.add(statusPanel, BorderLayout.CENTER);
        add(infoPanel, BorderLayout.NORTH);

        // Í≤åÏûÑ Ïπ¥Îìú Ìå®ÎÑê
        JPanel gamePanel = new JPanel(new GridLayout(difficulty.rows, difficulty.cols, 8, 8));
        gamePanel.setOpaque(false);

        String[] source = theme.themeName.equals("Animal") ? Data.ANIMALS : Data.FRUITS;

        for (int i = 0; i < difficulty.rows; i++) {
            for (int j = 0; j < difficulty.cols; j++) {
                buttons[i][j] = new JButton();
                buttons[i][j].setFont(UIFactory.FONT_CARD);
                buttons[i][j].setBackground(theme.cardBack);
                buttons[i][j].setFocusPainted(false);
                buttons[i][j].setBorder(BorderFactory.createLineBorder(theme.background, 2));

                final int x = i;
                final int y = j;

                buttons[i][j].addActionListener(e -> onCardClick(x, y));
                buttons[i][j].addMouseListener(new MouseAdapter() {
                    @Override
                    public void mouseEntered(MouseEvent e) {
                        if (buttons[x][y].isEnabled() && buttons[x][y].getText().isEmpty()) {
                            buttons[x][y].setBackground(theme.cardHover);
                        }
                    }
                    @Override
                    public void mouseExited(MouseEvent e) {
                        if (buttons[x][y].isEnabled() && buttons[x][y].getText().isEmpty()) {
                            buttons[x][y].setBackground(theme.cardBack);
                        }
                    }
                });
                gamePanel.add(buttons[i][j]);
            }
        }
        add(gamePanel, BorderLayout.CENTER);
    }

    private void onCardClick(int x, int y) {
        if (isChecking || matched[x][y] || (firstSelectX == x && firstSelectY == y)) {
            return;
        }

        SoundManager.play("click.wav");
        showItem(x, y);

        if (firstSelectX == -1) {
            firstSelectX = x;
            firstSelectY = y;
        } else {
            isChecking = true;
            checkSelectedCards(x, y);
        }
    }

    private void checkSelectedCards(int secondX, int secondY) {
        if (cardValues[firstSelectX][firstSelectY] == cardValues[secondX][secondY]) {
            // Ï†ïÎãµ
            SoundManager.play("match.wav");
            matched[firstSelectX][firstSelectY] = true;
            matched[secondX][secondY] = true;

            animateMatch(buttons[firstSelectX][firstSelectY]);
            animateMatch(buttons[secondX][secondY]);
            buttons[firstSelectX][firstSelectY].setEnabled(false);
            buttons[secondX][secondY].setEnabled(false);

            resetSelection();

            if (foundAllItems()) {
                if (gameTimer != null) gameTimer.stop();
                endGameListener.onGameEnd("üéâ Ï∂ïÌïòÌï©ÎãàÎã§! Í≤åÏûÑ ÌÅ¥Î¶¨Ïñ¥! üéâ", true);
            }
        } else {
            // Ïò§Îãµ
            SoundManager.play("mismatch.wav");
            failCount--;
            failLabel.setText("üí£ " + failCount);
            if (failCount <= 0) {
                if (gameTimer != null) gameTimer.stop();
                endGameListener.onGameEnd("Ïã§Ìå® ÌöüÏàò Ï¥àÍ≥º!", false);
                return;
            }
            Timer mismatchTimer = new Timer(800, e -> {
                hideItem(firstSelectX, firstSelectY);
                hideItem(secondX, secondY);
                resetSelection();
            });
            mismatchTimer.setRepeats(false);
            mismatchTimer.start();
        }
    }

    private void resetSelection() {
        firstSelectX = -1;
        firstSelectY = -1;
        isChecking = false;
    }

    private void showItem(int x, int y) {
        String[] source = theme.themeName.equals("Animal") ? Data.ANIMALS : Data.FRUITS;
        buttons[x][y].setText(source[cardValues[x][y]]);
        buttons[x][y].setBackground(theme.cardFront);
    }

    private void hideItem(int x, int y) {
        if (!matched[x][y]) {
            buttons[x][y].setText("");
            buttons[x][y].setBackground(theme.cardBack);
        }
    }

    private boolean foundAllItems() {
        for (boolean[] row : matched) {
            for (boolean cell : row) {
                if (!cell) return false;
            }
        }
        return true;
    }

    private void startTimer() {
        gameTimer = new Timer(1000, e -> {
            remainingSeconds--;
            timeLabel.setText("‚è≥ " + formatTime(remainingSeconds));
            if (remainingSeconds <= 0) {
                gameTimer.stop();
                endGameListener.onGameEnd("ÏãúÍ∞Ñ Ï¥àÍ≥º!", false);
            }
        });
        gameTimer.start();
    }

    private void peekCards() {
        // Î™®Îì† Ïπ¥ÎìúÎ•º Ïû†Ïãú Î≥¥Ïó¨Ï£ºÎäî Í∏∞Îä•
        for(int i=0; i<difficulty.rows; i++) {
            for (int j=0; j<difficulty.cols; j++) {
                showItem(i, j);
                buttons[i][j].setEnabled(false);
            }
        }

        Timer peekTimer = new Timer(2000, e -> {
             for(int i=0; i<difficulty.rows; i++) {
                for (int j=0; j<difficulty.cols; j++) {
                    hideItem(i, j);
                    buttons[i][j].setEnabled(true);
                }
            }
        });
        peekTimer.setRepeats(false);
        peekTimer.start();
    }

    private void animateMatch(JButton button) {
        final Color originalColor = theme.cardFront;
        final Color flashColor = Color.YELLOW;
        Timer flashTimer = new Timer(150, new ActionListener() {
            private int count = 0;
            @Override
            public void actionPerformed(ActionEvent e) {
                if (count % 2 == 0) {
                    button.setBackground(flashColor);
                } else {
                    button.setBackground(originalColor);
                }
                count++;
                if (count > 2) {
                    button.setBackground(theme.cardMatched);
                    ((Timer) e.getSource()).stop();
                }
            }
        });
        flashTimer.start();
    }

    private String formatTime(int seconds) {
        return String.format("%02d:%02d", seconds / 60, seconds % 60);
    }

    @FunctionalInterface
    interface EndGameListener {
        void onGameEnd(String message, boolean isWin);
    }
}

// =================================================================================
// Îç∞Ïù¥ÌÑ∞ Î∞è Ïú†Ìã∏Î¶¨Ìã∞ ÌÅ¥ÎûòÏä§
// =================================================================================

/** Í≤åÏûÑ ÌÖåÎßà Ï†ïÏùò */
class GameTheme {
    String themeName;
    Color background;
    Color cardBack;
    Color cardHover;
    Color cardMatched;
    Color cardFront;

    GameTheme(String themeName) {
        this.themeName = themeName;
        if (themeName.equals("Animal")) {
            this.background = new Color(222, 238, 214);
            this.cardBack = new Color(120, 153, 93);
            this.cardHover = new Color(140, 173, 113);
            this.cardMatched = new Color(200, 200, 200);
            this.cardFront = new Color(255, 215, 130);
        } else { // Fruit ÌÖåÎßà
            this.background = new Color(255, 235, 225);
            this.cardBack = new Color(255, 130, 130);
            this.cardHover = new Color(255, 150, 150);
            this.cardMatched = new Color(200, 200, 200);
            this.cardFront = new Color(170, 220, 255);
        }
    }
}


class Data {
    public static final String[] ANIMALS = {
        "üêµ", "ü¶Å", "üê∂", "üê±", "üê∑", "üêò", "üêª", "üê™", "üêß", "üêØ",
        "üê∞", "üê∏", "üêÆ", "üêî", "üê¥", "ü¶â", "ü¶ã", "üê¢"
    };
    public static final String[] FRUITS = {
        "üçé", "üçå", "üçì", "üçâ", "üçá", "üçë", "üçã", "üçê", "üçí", "üçç",
        "ü•ù", "üå∞", "ü•ë", "üçÖ", "üçÜ", "üåΩ", "üå∂Ô∏è", "üçÑ" // ü••Î•º ü•¶Î°ú ÍµêÏ≤¥
    };
}


enum Difficulty {
    EASY(4, 5, 300, 30),   // 5Î∂Ñ, Ïã§Ìå® 30Ìöå
    NORMAL(5, 6, 420, 30), // 7Î∂Ñ, Ïã§Ìå® 30Ìöå
    HARD(6, 6, 600, 30);   // 10Î∂Ñ, Ïã§Ìå® 30Ìöå

    final int rows, cols, timeLimit, failLimit;

    Difficulty(int rows, int cols, int timeLimit, int failLimit) {
        this.rows = rows;
        this.cols = cols;
        this.timeLimit = timeLimit; // Ï¥à Îã®ÏúÑ
        this.failLimit = failLimit; // ÌöüÏàò
    }
}


class UIFactory {
    public static final Color COLOR_BACKGROUND = new Color(245, 245, 245);
    public static final Color COLOR_EASY = new Color(102, 187, 106);
    public static final Color COLOR_NORMAL = new Color(66, 165, 245);
    public static final Color COLOR_HARD = new Color(239, 83, 80);

    public static final Font FONT_TITLE_MAIN = new Font("ÎÇòÎàîÍ≥†Îîï", Font.BOLD, 48);
    public static final Font FONT_TITLE = new Font("ÎÇòÎàîÍ≥†Îîï", Font.BOLD, 36);
    public static final Font FONT_BUTTON = new Font("ÎÇòÎàîÍ≥†Îîï", Font.BOLD, 24);
    public static final Font FONT_INFO = new Font("ÎÇòÎàîÍ≥†Îîï", Font.BOLD, 22);
    public static final Font FONT_CARD = new Font("SansSerif", Font.BOLD, 40);

    public static JButton createButton(String text, Color bgColor, ActionListener listener) {
        JButton button = new JButton(text) {
             @Override
             protected void paintComponent(Graphics g) {
                Graphics2D g2 = (Graphics2D) g.create();
                g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);

                // Í∑∏Î¶ºÏûê
                if (getModel().isPressed()) {
                    g2.setColor(bgColor.darker());
                    g2.fillRoundRect(0, 0, getWidth(), getHeight(), 25, 25);
                } else {
                    g2.setColor(Color.BLACK.darker());
                    g2.fillRoundRect(3, 3, getWidth()-3, getHeight()-3, 25, 25);
                    // Î≤ÑÌäº
                    g2.setColor(getModel().isRollover() ? bgColor.brighter() : bgColor);
                    g2.fillRoundRect(0, 0, getWidth() - 4, getHeight() - 4, 25, 25);
                }

                g2.setColor(getForeground());
                g2.setFont(getFont());
                FontMetrics metrics = g2.getFontMetrics(getFont());
                int x = (getWidth() - metrics.stringWidth(getText())) / 2;
                int y = ((getHeight() - metrics.getHeight()) / 2) + metrics.getAscent();
                g2.drawString(getText(), x, y);

                g2.dispose();
             }
        };

        button.setFont(FONT_BUTTON);
        button.setForeground(Color.WHITE);
        button.setFocusPainted(false);
        button.setCursor(new Cursor(Cursor.HAND_CURSOR));
        button.setBorder(new EmptyBorder(15,30,15,30));
        button.addActionListener(listener);
        button.setContentAreaFilled(false);
        return button;
    }

    public static JLabel createLabel(String text, Font font) {
        JLabel label = new JLabel(text);
        label.setFont(font);
        return label;
    }
}


class SoundManager {
    public static void play(String fileName) {
        /*
         * Ìö®Í≥ºÏùå ÌååÏùº(.wav)ÏùÑ ÌîÑÎ°úÏ†ùÌä∏ Ìè¥Îçî ÎÇ¥ 'resources' Ìè¥ÎçîÏóê ÎÑ£Í≥† ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.
         * ÏòàÏãú: ÌîÑÎ°úÏ†ùÌä∏Ìè¥Îçî/resources/click.wav
         *
         * try (Clip clip = AudioSystem.getClip()) {
         * URL url = SoundManager.class.getResource("/resources/" + fileName);
         * if (url != null) {
         * try (AudioInputStream audioIn = AudioSystem.getAudioInputStream(url)) {
         * clip.open(audioIn);
         * clip.start();
         * }
         * }
         * } catch (UnsupportedAudioFileException | IOException | LineUnavailableException e) {
         * // System.err.println("Sound Error: " + e.getMessage());
         * }
        */
    }
}
